schemaVersion: 2.0.0

metadataTest:
  entrypoint: ['node']
  cmd: ['server.js']
  workdir: '/app'
  exposedPorts: ['3000']
  user: 'node'
  envVars:
    - key: NODE_ENV
      value: production
    - key: NEXT_TELEMETRY_DISABLED
      value: '1'
    - key: HOSTNAME
      value: '0.0.0.0'
    - key: PORT
      value: '3000'

fileExistenceTests:
  - name: server.js present
    path: /app/server.js
    shouldExist: true
  - name: next static present
    path: /app/.next/static
    shouldExist: true
  - name: /bin/sh absent
    path: /bin/sh
    shouldExist: false
  - name: bash absent
    path: /usr/bin/bash
    shouldExist: false
  - name: apt-get absent
    path: /usr/bin/apt-get
    shouldExist: false
  - name: dpkg absent
    path: /usr/bin/dpkg
    shouldExist: false
  - name: yum absent
    path: /usr/bin/yum
    shouldExist: false
  - name: apk absent
    path: /sbin/apk
    shouldExist: false
  - name: npm absent
    path: /usr/bin/npm
    shouldExist: false
  - name: pnpm absent
    path: /usr/bin/pnpm
    shouldExist: false
  - name: scripts directory absent
    path: /app/scripts
    shouldExist: false

commandTests:
  - name: uid is non-root
    command: 'node'
    args: ['-p', 'process.getuid()']
    exitCode: 0
    expectedOutput: ['1000']

  - name: gid is non-root
    command: 'node'
    args: ['-p', 'process.getgid()']
    exitCode: 0
    expectedOutput: ['1000']

  - name: NODE_ENV is production
    command: 'node'
    args: ['-p', 'process.env.NODE_ENV']
    exitCode: 0
    expectedOutput: ['production']

  - name: telemetry disabled
    command: 'node'
    args: ['-p', 'process.env.NEXT_TELEMETRY_DISABLED']
    exitCode: 0
    expectedOutput: ['1']

  - name: rootfs not writable by app user
    command: 'node'
    args:
      ['-e', "require('fs').writeFile('/.cst_wr','x',e=>process.exit(e?0:1))"]
    exitCode: 0

  - name: CAP_SYS_ADMIN absent
    command: 'node'
    args:
      - '-e'
      - |
        const fs=require('fs');
        const m=fs.readFileSync('/proc/self/status','utf8').match(/^CapEff:\s*([0-9A-Fa-f]+)$/m);
        if(!m){process.exit(1)}
        const eff=BigInt('0x'+m[1]);
        const CAP_SYS_ADMIN=1n<<21n;
        process.exit((eff & CAP_SYS_ADMIN)===0n?0:1);
    exitCode: 0

  - name: server.js readable
    command: 'node'
    args:
      [
        '-e',
        "require('fs').access('/app/server.js',require('fs').constants.R_OK,e=>process.exit(e?1:0))",
      ]
    exitCode: 0

  # File Permission Tests
  - name: server.js is executable
    command: 'node'
    args:
      [
        '-e',
        "require('fs').access('/app/server.js',require('fs').constants.X_OK,e=>process.exit(e?1:0))",
      ]
    exitCode: 0

  - name: server.js has correct permissions (500)
    command: 'node'
    args:
      - '-e'
      - |
        const fs=require('fs');
        const stat=fs.statSync('/app/server.js');
        const mode=(stat.mode&parseInt('777',8)).toString(8);
        process.exit(mode==='500'?0:1);
    exitCode: 0

  - name: public directory folder permissions (555)
    command: 'node'
    args:
      - '-e'
      - |
        const fs=require('fs');
        const path=require('path');
        function check(dir) {
          const items = fs.readdirSync(dir, { withFileTypes: true });
          // Check current directory
          const mode = (fs.statSync(dir).mode & parseInt('777', 8)).toString(8);
          if (mode !== '555') {
            console.error('ERROR: Directory ' + dir + ' has mode ' + mode + ', expected 555');
            process.exit(1);
          }

          for (const item of items) {
            const res = path.resolve(dir, item.name);
            if (item.isDirectory()) {
              check(res);
            } else {
              const fileMode = (fs.statSync(res).mode & parseInt('777', 8)).toString(8);
              if (fileMode !== '444') {
                console.error('ERROR: File ' + res + ' has mode ' + fileMode + ', expected 444');
                process.exit(1);
              }
            }
          }
        }
        try {
          check('/app/public');
        } catch (e) {
          console.error(e);
          process.exit(1);
        }
    exitCode: 0

  - name: public directory is not writable
    command: 'node'
    args:
      [
        '-e',
        "require('fs').access('/app/public',require('fs').constants.W_OK,e=>process.exit(e?0:1))",
      ]
    exitCode: 0

  - name: .next directory is writable for ISR
    command: 'node'
    args:
      [
        '-e',
        "require('fs').access('/app/.next',require('fs').constants.W_OK,e=>process.exit(e?1:0))",
      ]
    exitCode: 0

  - name: app files owned by node user (uid 1000)
    command: 'node'
    args:
      - '-e'
      - |
        const fs=require('fs');
        const stat=fs.statSync('/app/server.js');
        process.exit(stat.uid===1000?0:1);
    exitCode: 0

  - name: app files owned by node group (gid 1000)
    command: 'node'
    args:
      - '-e'
      - |
        const fs=require('fs');
        const stat=fs.statSync('/app/server.js');
        process.exit(stat.gid===1000?0:1);
    exitCode: 0

  - name: .next/static directory exists and is readable
    command: 'node'
    args:
      [
        '-e',
        "require('fs').access('/app/.next/static',require('fs').constants.R_OK,e=>process.exit(e?1:0))",
      ]
    exitCode: 0
