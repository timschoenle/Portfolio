name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  IMAGE_TAG: app:test-${{ github.sha }}
  STORED_IMAGE_NAME: docker-image-tar
  PNPM_VERSION: '10'
  NODE_VERSION: '24'

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  # Detect which files changed to conditionally run jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      source: ${{ steps.filter.outputs.source }}
      tests: ${{ steps.filter.outputs.tests }}
      e2e: ${{ steps.filter.outputs.e2e }}
      docker: ${{ steps.filter.outputs.docker }}
      dockerfile-lint: ${{ steps.filter.outputs.dockerfile-lint }}
      lighthouse: ${{ steps.filter.outputs.lighthouse }}
      bundle: ${{ steps.filter.outputs.bundle }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Check for file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            # Common paths used across multiple filters
            source: &source_files
              - &src_path 'src/**'
              - &config_files '*.config.*'
              - &pkg_json 'package.json'
              - &github_path '.github/**'
              - 'pnpm-lock.yaml'
              - 'messages/**'
              - 'public/**'

            tests:
              - *src_path
              - 'test/**'
              - 'vitest.config.ts'
              - *pkg_json
              - *github_path

            e2e:
              - *src_path
              - 'tests/**'
              - 'playwright.config.ts'
              - *pkg_json
              - *github_path

            docker:
              - 'Dockerfile'
              - 'docker-compose.yml'
              - '.dockerignore'
              - *src_path
              - *pkg_json
              - *github_path

            dockerfile-lint:
              - 'Dockerfile'
              - '.hadolint.yaml'

            lighthouse:
              - *src_path
              - 'public/**'
              - '.github/lighthouse/**'
              - *config_files
              - *pkg_json
              - *github_path

            bundle:
              - *src_path
              - *config_files
              - *pkg_json
              - *github_path

  # Install dependencies once and cache for all parallel jobs
  install-deps:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.source == 'true'
    outputs:
      cache-hit: ${{ steps.cache-check.outputs.cache-hit }}
      node-modules-mode: ${{ steps.cache-check.outputs.cache-hit == 'true' && 'cache' || 'artifact' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Check for existing node_modules cache
        id: cache-check
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: node_modules
          key: &cache_key node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          lookup-only: true

      - name: Restore pnpm store cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        id: store-restore
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      - name: Save node_modules cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: node_modules
          key: *cache_key

      - name: Save pnpm store cache
        if: steps.cache-check.outputs.cache-hit != 'true' && steps.store-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Upload node_modules artifact
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: node-modules
          path: node_modules
          retention-days: 1

  # Quality checks - run in parallel using cached dependencies
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run ESLint
        run: pnpm run lint --max-warnings=0

  format-check:
    name: Format Check (Prettier)
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run Prettier
        run: pnpm run format:check

  type-check:
    name: Type Check (TypeScript)
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run TypeScript
        run: pnpm run type-check

  i18n-check:
    name: i18n Validation
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run i18n check
        run: pnpm run i18n-check

  knip-check:
    name: Dependency Check (Knip)
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run Knip
        run: pnpm run lint:deps

  # Unit and component tests
  test:
    name: Unit & Component Tests
    runs-on: ubuntu-latest
    needs: install-deps
    if: needs.changes.outputs.tests == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Run tests
        run: pnpm run test:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Production build - shared across multiple jobs
  build:
    name: Production Build
    runs-on: ubuntu-latest
    needs:
      [
        changes,
        install-deps,
        lint,
        format-check,
        type-check,
        i18n-check,
        knip-check,
      ]
    if: needs.changes.outputs.source == 'true'
    timeout-minutes: 15
    env:
      NEXT_TELEMETRY_DISABLED: 1
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Restore Next.js cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-

      - name: Build
        run: pnpm run build

      - name: Upload build artifact
        if: success()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: nextjs-build
          include-hidden-files: true
          path: |
            .next/**/*
            !.next/cache
          retention-days: 1

  # E2E tests using shared build
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [changes, install-deps, build]
    if: needs.changes.outputs.e2e == 'true' && needs.changes.outputs.source == 'true'
    timeout-minutes: 30
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      TEST_LOCALE: en
      BASE_URL: http://localhost:3000
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Restore build artifact
        uses: ./.github/actions/restore-build

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: Ensure Playwright is correctly installed
        run: pnpm exec playwright install

      - name: Run E2E tests
        run: pnpm exec playwright test --reporter=github,html,junit

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report
          if-no-files-found: ignore
          retention-days: 14

  # Lighthouse audit using shared build
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    needs: [changes, install-deps, build]
    if: needs.changes.outputs.lighthouse == 'true' && needs.changes.outputs.source == 'true'
    strategy:
      fail-fast: false
      matrix:
        formFactor: [mobile, desktop]
    timeout-minutes: 15
    env:
      BASE_URL: 'http://localhost:3000'
      TARGET_PATHS: |
        /en
        /de
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Restore build artifact
        uses: ./.github/actions/restore-build

      - name: Start Next.js server
        run: pnpm run start & npx wait-on@latest "$BASE_URL"

      - name: Warm up URLs
        run: |
          while IFS= read -r path; do
            [ -z "$path" ] && continue
            url="${BASE_URL}${path}"
            echo "Warming $url"
            for i in 1 2; do
              curl -sS -o /dev/null --retry 5 --retry-connrefused --retry-delay 1 --max-time 20 "$url"
            done
          done <<< "${TARGET_PATHS}"

      - name: Resolve URL list for Lighthouse
        id: resolve-urls
        run: |
          {
            echo 'urls<<EOF'
            while IFS= read -r path; do
              [ -z "$path" ] && continue
              echo "${BASE_URL}${path}"
            done <<< "${TARGET_PATHS}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@fcd65974f7c4c2bf0ee9d09b84d2489183c29726 # v12
        with:
          urls: ${{ steps.resolve-urls.outputs.urls }}
          configPath: './.github/lighthouse/lighthouserc.js'
          uploadArtifacts: false
          temporaryPublicStorage: true
        env:
          LHCI_FORM_FACTOR: ${{ matrix.formFactor }}

  # Bundle analysis using shared build
  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    needs: [changes, install-deps, build]
    if: needs.changes.outputs.bundle == 'true' && needs.changes.outputs.source == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup with dynamic mode
        uses: ./.github/actions/setup-pnpm-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          mode: ${{ needs.install-deps.outputs.node-modules-mode }}
          cache-key: *cache_key

      - name: Build and Analyze
        run: pnpm run analyze

      - name: Generate Report
        run: npx -p nextjs-bundle-analysis report

      - name: Upload bundle
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: bundle
          path: .next/analyze/__bundle_analysis.json
          retention-days: 1

      - name: Download base branch bundle stats
        uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5 # v11
        if: success() && github.event.number
        continue-on-error: true
        with:
          workflow: ci.yaml
          branch: ${{ github.event.pull_request.base.ref }}
          name: bundle
          path: .next/analyze/base

      - name: Compare with base branch bundle
        if: success() && github.event.number && hashFiles('.next/analyze/base/**/*') != ''
        run: ls -laR .next/analyze/base && npx -p nextjs-bundle-analysis compare

      - name: Get comment body
        id: get-comment-body
        if: success() && github.event.number
        run: |
          if [ -f .next/analyze/__bundle_analysis_comment.txt ]; then
            echo "body<<EOF" >> $GITHUB_OUTPUT
            cat .next/analyze/__bundle_analysis_comment.txt >> $GITHUB_OUTPUT
            echo EOF >> $GITHUB_OUTPUT
          else
            echo "body=" >> $GITHUB_OUTPUT
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4
        if: success() && github.event.number && steps.get-comment-body.outputs.body != ''
        id: fc
        with:
          issue-number: ${{ github.event.number }}
          body-includes: '<!-- __NEXTJS_BUNDLE -->'

      - name: Create comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5
        if: success() && github.event.number && steps.fc.outputs.comment-id == '' && steps.get-comment-body.outputs.body != ''
        with:
          issue-number: ${{ github.event.number }}
          body: ${{ steps.get-comment-body.outputs.body }}

      - name: Update comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5
        if: success() && github.event.number && steps.fc.outputs.comment-id != '' && steps.get-comment-body.outputs.body != ''
        with:
          issue-number: ${{ github.event.number }}
          body: ${{ steps.get-comment-body.outputs.body }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace

  # Dockerfile linting
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.dockerfile-lint == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Hadolint
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: Dockerfile
          config: .hadolint.yaml
          format: tty

  # Consolidated Docker pipeline (Build -> Test -> Scan)
  docker-pipeline:
    name: Docker Pipeline
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup Docker QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Build with Buildx
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=min

      - name: Run structure tests
        run: |
          docker pull gcr.io/gcp-runtimes/container-structure-test:latest
          docker run --rm \
            -v $PWD/cst.yaml:/cst.yaml \
            -v /var/run/docker.sock:/var/run/docker.sock \
            gcr.io/gcp-runtimes/container-structure-test:latest test \
            --image $IMAGE_TAG --config /cst.yaml

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          image-ref: ${{ env.IMAGE_TAG }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  # Cleanup build artifacts after all consuming jobs complete
  cleanup-artifacts:
    name: Cleanup Build Artifacts
    runs-on: ubuntu-latest
    needs: [install-deps, e2e, lighthouse, bundle-analysis]
    if: always()
    permissions:
      actions: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Delete build artifact
        uses: ./.github/actions/delete-artifact
        with:
          artifact-name: nextjs-build
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete node_modules artifact
        if: needs.install-deps.outputs.node-modules-mode == 'artifact'
        uses: ./.github/actions/delete-artifact
        with:
          artifact-name: node-modules
          github-token: ${{ secrets.GITHUB_TOKEN }}
