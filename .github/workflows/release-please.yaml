name: release-please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  DOCKER_REPO: timschoenle/portfolio
  HELM_REPO: TimSchoenle/helm-charts
  HELM_CHECKOUT_PATH: helm-charts
  CHART_PATH: charts/portfolio

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          token: ${{ steps.generate_token.outputs.token }}

  publish-docker:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    outputs:
      image_digest: ${{ steps.build-and-push.outputs.digest }}
    permissions:
      contents: read
      id-token: write # Needed for Cosign keyless signing
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Get Git commit timestamps
        run: echo "TIMESTAMP=$(git log -1 --pretty=%ct)" >> $GITHUB_ENV

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to DHI Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.DOCKER_REPO }}
          tags: |
            type=raw,value=${{ needs.release-please.outputs.tag_name }}

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        env:
          SOURCE_DATE_EPOCH: ${{ env.TIMESTAMP }}
        with:
          context: .
          push: true
          provenance: mode=max
          sbom: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GIT_SHA=${{ github.sha }}
            SENTRY_RELEASE=${{ needs.release-please.outputs.tag_name }}
          secrets: |
            resume_signing_cert_base64=${{ secrets.RESUME_SIGNING_CERT_BASE64 }}
            resume_signing_cert_password=${{ secrets.RESUME_SIGNING_CERT_PASSWORD }}
            SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}
            SENTRY_ORG=${{ secrets.SENTRY_ORG }}
            SENTRY_PROJECT=${{ secrets.SENTRY_PROJECT }}

      - name: Sign the published Docker image
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
          DIGEST: ${{ steps.build-and-push.outputs.digest }}
        run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}

  create-sentry-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Create Sentry release
        uses: getsentry/action-release@128c5058bbbe93c8e02147fe0a9c713f166259a6 # v3
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ needs.release-please.outputs.tag_name }}

  update-helm-chart:
    needs: [release-please, publish-docker]
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Get Bot User Data
        id: bot_data
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          # Fetch the bot's user data
          USER_DATA=$(gh api user)
          echo "BOT_NAME=$(echo "$USER_DATA" | jq -r .login)" >> $GITHUB_ENV
          echo "BOT_EMAIL=$(echo "$USER_DATA" | jq -r .id)+$(echo "$USER_DATA" | jq -r .login)@users.noreply.github.com" >> $GITHUB_ENV

      - name: Checkout Helm Charts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: ${{ env.HELM_REPO }}
          token: ${{ steps.generate_token.outputs.token }}
          path: ${{ env.HELM_CHECKOUT_PATH }}
          fetch-depth: 0

      - name: Configure Git
        working-directory: ${{ env.HELM_CHECKOUT_PATH }}
        run: |
          git config user.name "${{ env.BOT_NAME }}"
          git config user.email "${{ env.BOT_EMAIL }}"

      - name: Install yq
        uses: dcarbone/install-yq-action@v1.3.1
        with:
          version: 'v4.40.1'

      - name: Update Chart Version
        working-directory: ${{ env.HELM_CHECKOUT_PATH }}/${{ env.CHART_PATH }}
        env:
          NEW_TAG: ${{ needs.release-please.outputs.tag_name }}
          IMAGE_DIGEST: ${{ needs.publish-docker.outputs.image_digest }}
        run: |
          # Bump patch version
          # Extract current version
          CURRENT_VERSION=$(yq '.version' Chart.yaml)
          echo "Current Version: $CURRENT_VERSION"

          # Increment patch
          NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "New Version: $NEW_VERSION"

          # Update Chart.yaml
          yq -i ".version = \"$NEW_VERSION\"" Chart.yaml
          yq -i ".appVersion = \"$NEW_TAG\"" Chart.yaml

          # Update values.yaml image tag
          # Format: [TAG]@[DIGEST]
          FULL_TAG="${NEW_TAG}@${IMAGE_DIGEST}"
          echo "New Image Tag: $FULL_TAG"
          yq -i ".image.tag = \"$FULL_TAG\"" values.yaml

      - name: Create Pull Request
        working-directory: ${{ env.HELM_CHECKOUT_PATH }}
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          NEW_TAG: ${{ needs.release-please.outputs.tag_name }}
        run: |
          BRANCH_NAME="chore/update-portfolio-${NEW_TAG}"

          # Create branch
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add ${{ env.CHART_PATH }}/Chart.yaml ${{ env.CHART_PATH }}/values.yaml
          git commit -m "chore(portfolio): update chart for release ${NEW_TAG}"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "chore(portfolio): update chart for release ${NEW_TAG}" \
            --body "Automated update for Portfolio release [${NEW_TAG}](https://github.com/${{ github.repository }}/releases/tag/${NEW_TAG})." \
            --base main \
            --head "$BRANCH_NAME" \
            --repo ${{ env.HELM_REPO }}
