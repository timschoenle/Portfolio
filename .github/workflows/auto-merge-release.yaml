name: Auto Merge Release PRs

on:
  schedule:
    - cron: '0 5 * * *' # Run daily at 5:00 UTC
  pull_request:
    types:
      - labeled
      - unlabeled
      - synchronize
      - opened
      - edited
      - ready_for_review
      - review_requested
      - review_request_removed
  check_suite:
    types:
      - completed
  status: {}
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  label-old-prs:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    env:
      AGE_THRESHOLD_DAYS: '7'
      RELEASE_LABEL: 'autorelease: pending'
      RELEASE_BRANCH_PREFIX: 'release-please--'
      TARGET_LABEL: 'ready-to-merge'
    steps:
      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Label old release PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const AGE_THRESHOLD_DAYS = parseInt(process.env.AGE_THRESHOLD_DAYS || "7", 10);
            const RELEASE_LABEL = process.env.RELEASE_LABEL || "autorelease: pending";
            const RELEASE_BRANCH_PREFIX = process.env.RELEASE_BRANCH_PREFIX || "release-please--";
            const TARGET_LABEL = process.env.TARGET_LABEL || "ready-to-merge";

            // Get the authenticated bot user to find its ID dynamically
            const { data: currentUser } = await github.rest.users.getAuthenticated();
            console.log(`Authenticated as: ${currentUser.login} (ID: ${currentUser.id})`);

            const AGE_THRESHOLD_MS = AGE_THRESHOLD_DAYS * 24 * 60 * 60 * 1000;
            const now = new Date();

            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            for (const pr of pullRequests) {
              const isReleaseBot = pr.user.id === currentUser.id;
              const hasReleaseLabel = pr.labels.some(label => label.name === RELEASE_LABEL);
              const isReleaseBranch = pr.head.ref.startsWith(RELEASE_BRANCH_PREFIX);

              if (isReleaseBot && (hasReleaseLabel || isReleaseBranch)) {
                const createdDate = new Date(pr.created_at);
                const age = now - createdDate;

                if (age > AGE_THRESHOLD_MS) {
                  // Check if label already exists
                  if (!pr.labels.some(l => l.name === TARGET_LABEL)) {
                    console.log(`Labeling PR #${pr.number} ("${pr.title}") with "${TARGET_LABEL}"`);
                    await github.rest.issues.addLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: pr.number,
                      labels: [TARGET_LABEL]
                    });
                  } else {
                     console.log(`PR #${pr.number} already has "${TARGET_LABEL}"`);
                  }
                }
              }
            }

  automerge:
    needs: label-old-prs
    if: |
      always() && 
      (needs.label-old-prs.result == 'success' || needs.label-old-prs.result == 'skipped') &&
      (
        github.event_name != 'pull_request' || 
        contains(github.event.pull_request.labels.*.name, 'ready-to-merge')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve
        uses: hmarr/auto-approve-action@v4
        with:
          review-message: 'Auto-approved for Release Please automerge.'

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - id: automerge
        name: automerge
        uses: 'pascalgn/automerge-action@v0.16.4'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token }}'
          MERGE_LABELS: 'ready-to-merge'
          MERGE_METHOD: 'squash'
          MERGE_COMMIT_MESSAGE: 'pull-request-title'
          MERGE_FILTER_AUTHOR: ''
